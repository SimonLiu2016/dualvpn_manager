# 智能路由功能说明

## 功能概述

DualVPN Manager 的智能路由功能允许用户配置复杂的网络流量路由规则，根据域名、IP 地址等条件将不同的网络请求路由到不同的代理服务器。

## 核心组件

### 1. 智能路由引擎 (SmartRoutingEngine)

负责根据用户配置的路由规则决定网络请求的走向。

支持的路由规则类型：

- 域名完全匹配 (domain)
- 域名后缀匹配 (domainSuffix)
- 域名关键字匹配 (domainKeyword)
- IP 地址匹配 (ip)
- CIDR IP 段匹配 (cidr)
- 正则表达式匹配 (regexp)
- 最终规则 (finalRule)

### 2. 代理管理器 (ProxyManager)

负责管理多个代理的协调工作和流量转发。

### 3. 系统代理管理器 (SystemProxyManager)

负责在不同操作系统上设置和清除系统代理。

## 使用流程

1. **配置代理源**：在应用中添加并启用多个代理源（Clash、Shadowsocks、V2Ray 等）

2. **配置路由规则**：

   - 进入路由配置页面
   - 添加路由规则，指定匹配模式和目标代理
   - 启用需要的路由规则

3. **启用智能路由**：

   - 点击"启用路由"按钮
   - 系统会自动设置系统代理指向本地代理服务
   - 本地代理服务根据路由规则转发流量

4. **验证功能**：
   - 访问配置的域名，观察是否通过指定代理访问
   - 检查代理源的流量统计信息

## 技术实现

### 路由决策流程

1. 系统网络请求 → 系统代理 → 本地代理服务
2. 本地代理服务分析目标域名/IP
3. 智能路由引擎根据路由规则匹配
4. 根据匹配结果决定转发到哪个代理或直连

### TUN 模式支持

Clash 配置已启用 TUN 模式，支持透明代理：

```yaml
tun:
  enable: true
  stack: system
  dns-hijack:
    - 0.0.0.0:53
  auto-route: true
  auto-detect-interface: true
```

## 常见问题

### 1. 路由规则不生效

- 检查路由规则是否已启用
- 确认代理源是否已正确配置并启用
- 验证系统代理是否已正确设置

### 2. 代理连接失败

- 检查代理配置文件是否正确
- 确认代理服务是否正常运行
- 验证网络连接是否正常

## 测试验证

项目包含完整的单元测试和集成测试，确保路由功能的正确性：

- `test/integration/smart_routing_test.dart` - 智能路由引擎测试
- `test/integration/full_routing_flow_test.dart` - 完整路由流程测试
